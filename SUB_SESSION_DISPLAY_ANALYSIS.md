# Sub-Session Display Analysis

**Issue:** Recipe sub-agent output appears left-aligned instead of indented
**Date:** 2025-11-18
**Status:** Root cause identified

---

## The Problem

When recipes execute and spawn sub-agents:
- **Task tool**: Sub-agent output is properly indented with 4 spaces
- **Recipes tool**: Sub-agent output is left-aligned (not indented)

**Expected behavior:** Sub-agent output should be indented for visual clarity

---

## Root Cause: Session ID Format Mismatch

### Format Generated by session_spawner.py

**Function:** `_generate_sub_session_id()` (lines 22-73)

**Format:** `{parent-span}-{child-span}_{agent-name}`

**Example:** `0000000000000000-7cc787dd22d54f6c_developer-expertise-zen-architect`

**Key:** Uses **underscore** (`_`) before agent name

### Format Expected by hooks-streaming-ui

**Function:** `_parse_agent_from_session_id()` (lines 63-92)

**Expected Format:** `{uuid-parts}-{agent-name}-{8chars}`

**Example:** `12345678-1234-1234-1234-123456789012-zen-architect-abcd1234`

**Key:** Uses **dashes** (`-`) throughout, expects last part to be exactly 8 chars

### The Mismatch

```python
# Generated ID:
"0000000000000000-7cc787dd22d54f6c_developer-expertise-zen-architect"
                                    â†‘
                              Underscore!

# Parser expects:
"uuid-uuid-uuid-uuid-uuid-agent-name-8chars"
                         â†‘           â†‘
                    All dashes!   Last part = 8 chars
```

**Result of parsing:**
```python
parts = id.split("-")
# ["0000000000000000", "7cc787dd22d54f6c_developer", "expertise", "zen", "architect"]
#                                      â†‘ Underscore breaks the parse!

# Check if last part is 8 chars
len(parts[-1]) != 8  # "architect" is 9 chars
# Returns None - agent NOT detected!
```

### Why It Works for Task Tool

The task tool uses the SAME `spawn_sub_session()` function, so it generates the SAME underscore format.

**But the output still gets indented!**

This suggests hooks-streaming-ui must have been updated at some point but there's still a mismatch, OR there's a different code path I haven't found yet.

---

## Evidence

### Actual Sub-Session IDs from Recipe Execution

From `~/.amplifier/projects/.../recipe-sessions/recipe_20251118_114317_32980e84/state.json`:

```json
"session_id": "0000000000000000-7cc787dd22d54f6c_developer-expertise-zen-architect"
"session_id": "0000000000000000-bbdc4822a3934c01_developer-expertise-zen-architect"
"session_id": "0000000000000000-e7a26027edc840f7_developer-expertise-zen-architect"
```

All use **underscore format**.

### hooks-streaming-ui Parser Logic

```python
# Line 78-81: Split by dash
parts = session_id.split("-")

# Line 81: Check if last part is 8 chars
if len(parts) < 3 or len(parts[-1]) != 8 or not parts[-1].isalnum():
    return None  # Not detected as sub-agent!

# Line 87-90: Extract agent name
if len(parts) >= 7:  # At least 5 UUID parts + agent + short ID
    agent_parts = parts[5:-1]  # Skip first 5 (UUID) and last 1 (short ID)
    return "-".join(agent_parts) if agent_parts else None
```

This logic **cannot parse underscore format**.

---

## Solutions

### Option A: Update hooks-streaming-ui Parser (Recommended)

**Change:** Modify `_parse_agent_from_session_id()` to handle underscore format

```python
def _parse_agent_from_session_id(self, session_id: str | None) -> str | None:
    """Extract agent name from hierarchical session ID.

    Supports two formats:
    1. W3C Trace Context: {parent-span}-{child-span}_{agent-name}
    2. Legacy UUID: {uuid}-{agent-name}-{8chars}
    """
    if not session_id:
        return None

    # NEW: Check for W3C Trace Context format (underscore separator)
    if "_" in session_id:
        # Format: {parent-span}-{child-span}_{agent-name}
        # Example: 0000000000000000-7cc787dd22d54f6c_developer-expertise-zen-architect
        parts = session_id.split("_", 1)  # Split on first underscore
        if len(parts) == 2:
            return parts[1]  # Everything after underscore is agent name

    # EXISTING: Legacy UUID format with dashes
    parts = session_id.split("-")
    # ... existing logic ...
```

**Pros:**
- âœ… Minimal change to hooks-streaming-ui
- âœ… Backward compatible with legacy format
- âœ… Matches actual session_spawner implementation
- âœ… Handles both formats gracefully

**Cons:**
- âš ï¸ Need to update hooks-streaming-ui module

### Option B: Update session_spawner Format

**Change:** Modify `_generate_sub_session_id()` to use dash format

**Pros:**
- âœ… Matches hooks-streaming-ui expectations
- âœ… No changes to UI logic needed

**Cons:**
- âŒ Breaks W3C Trace Context format (uses underscores intentionally)
- âŒ More complex ID parsing (no clear separator before agent)
- âŒ Requires careful parsing to extract spans vs agent name

### Option C: Do Nothing (Current State)

**Keep:** Sub-agent output left-aligned

**Pros:**
- âœ… No code changes needed
- âœ… Still functional (just not pretty)

**Cons:**
- âŒ Poor UX - hard to distinguish parent vs sub-agent output
- âŒ Inconsistent with task tool behavior
- âŒ User complained (it's a real UX problem)

---

## Recommendation: Option A (Update hooks-streaming-ui)

**Why:**
1. The W3C Trace Context format in session_spawner is intentional and good design
2. Underscore is a clearer separator (can't appear in hex spans)
3. Easier to parse (single underscore split)
4. Minimal change to hooks-streaming-ui
5. Backward compatible (still handles legacy format)

**Implementation:**
1. Update `_parse_agent_from_session_id()` in hooks-streaming-ui
2. Add comment explaining both formats
3. Test with both recipe and task tool
4. Commit fix

**Estimated effort:** 15 minutes

---

## Implementation

### Current hooks-streaming-ui Logic (Lines 63-92)

```python
def _parse_agent_from_session_id(self, session_id: str | None) -> str | None:
    """Extract agent name from hierarchical session ID."""
    if not session_id:
        return None

    # Hierarchical pattern: {parent-uuid}-{agent-name}-{8char}
    parts = session_id.split("-")

    # Check if last part is 8-char ID
    if len(parts) < 3 or len(parts[-1]) != 8 or not parts[-1].isalnum():
        return None

    # Extract agent name between UUID and short ID
    if len(parts) >= 7:
        agent_parts = parts[5:-1]
        return "-".join(agent_parts) if agent_parts else None

    return None
```

### Proposed Fix

```python
def _parse_agent_from_session_id(self, session_id: str | None) -> str | None:
    """Extract agent name from hierarchical session ID.

    Supports two session ID formats:
    1. W3C Trace Context: {parent-span}-{child-span}_{agent-name}
       Example: 0000000000000000-7cc787dd22d54f6c_developer-expertise-zen-architect

    2. Legacy UUID: {uuid-parts}-{agent-name}-{8chars}
       Example: 12345678-1234-1234-1234-123456789012-zen-architect-abcd1234

    Returns:
        Agent name if child session detected, None if parent session
    """
    if not session_id:
        return None

    # NEW: W3C Trace Context format (used by session_spawner since 2025-10)
    # Format: {parent-span}-{child-span}_{agent-name}
    # Underscore is the key separator
    if "_" in session_id:
        parts = session_id.split("_", 1)  # Split on first underscore only
        if len(parts) == 2:
            # Everything after underscore is agent name
            # Example: "developer-expertise-zen-architect"
            return parts[1]

    # EXISTING: Legacy UUID format (dash-separated throughout)
    # Format: {uuid-parts}-{agent-name}-{8chars}
    parts = session_id.split("-")

    # Check if last part is 8-char ID
    if len(parts) < 3 or len(parts[-1]) != 8 or not parts[-1].isalnum():
        return None  # Not legacy format either

    # Extract agent name between UUID and short ID
    if len(parts) >= 7:
        agent_parts = parts[5:-1]
        return "-".join(agent_parts) if agent_parts else None

    return None
```

### Testing the Fix

```python
# Test W3C Trace Context format
assert _parse_agent_from_session_id(
    "0000000000000000-7cc787dd22d54f6c_developer-expertise-zen-architect"
) == "developer-expertise-zen-architect"

# Test legacy UUID format
assert _parse_agent_from_session_id(
    "12345678-1234-1234-1234-123456789012-zen-architect-abcd1234"
) == "zen-architect"

# Test parent session (no agent)
assert _parse_agent_from_session_id(
    "12345678-1234-1234-1234-123456789012"
) is None
```

---

## Impact

**Once fixed:**
- âœ… Recipe sub-agent output will be indented with 4 spaces
- âœ… Agent names shown in brackets `[developer-expertise-zen-architect]`
- âœ… Tool calls use box-drawing characters (â”Œâ”€, â”‚, â””â”€)
- âœ… Consistent with task tool behavior
- âœ… Clear visual hierarchy in output

**Example output (after fix):**

```
ðŸ”§ Using tool: recipes
   Arguments: {'operation': 'execute', ...}

    ðŸ¤” [developer-expertise-zen-architect] Thinking...

    ============================================================
    [developer-expertise-zen-architect] Thinking:
    ------------------------------------------------------------
    I need to analyze the README.md file...
    ============================================================

    â”Œâ”€ ðŸ”§ [developer-expertise-zen-architect] Using tool: read_file
    â”‚  Arguments: {'file_path': 'README.md'}
    â””â”€ âœ… [developer-expertise-zen-architect] Tool result: read_file
       {'content': '...'}

âœ… Tool result: recipes
   {'status': 'completed', ...}
```

---

## Next Steps

1. **Update hooks-streaming-ui** with proposed fix
2. **Test with recipes** - Verify indenting works
3. **Test with task tool** - Verify no regression
4. **Commit fix** - Update hooks-streaming-ui module

**File to modify:**
`amplifier-module-hooks-streaming-ui/amplifier_module_hooks_streaming_ui/__init__.py`

**Function to update:**
`StreamingUIHooks._parse_agent_from_session_id()` (lines 63-92)

**Testing:**
- Execute recipe and verify indenting appears
- Check that agent names are extracted correctly
- Verify tool calls show box-drawing characters
- Ensure thinking blocks are indented
